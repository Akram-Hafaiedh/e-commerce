generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String
  role      UserRole  @default(USER)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  address   String?
  avatar    String?
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  phone     String?

  // Relations
  cart           Cart? // One-to-one relationship
  orders         Order[]
  savedAddresses SavedAddress[]

  @@map("users")
}

model SavedAddress {
  id     String @id @default(cuid())
  userId String

  firstName String
  lastName  String
  address   String
  city      String
  zipCode   String
  country   String
  phone     String?

  isDefault Boolean @default(false) // Default shipping address
  label     String? // "Home", "Work", etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDefault])
  @@map("saved_addresses")
}

model Product {
  id            String  @id @default(cuid())
  name          String
  description   String  @db.Text
  price         Float
  originalPrice Float?
  image         String
  slug          String  @unique
  sku           String? @unique // NEW: For inventory management
  featured      Boolean @default(false)
  onSale        Boolean @default(false)
  isActive      Boolean @default(true) // NEW: Soft delete

  // stock management
  stock             Int @default(0) // CACHED: Sum of all inventory
  lowStockThreshold Int @default(10) // NEW: Alert threshold

  // Analytics
  soldCount Int @default(0) // NEW: For bestsellers
  viewCount Int @default(0) // NEW: For analytics

  rating      Float?
  reviewCount Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  categoryId  String

  // Relations
  cartItems      CartItem[]
  orderItems     OrderItem[]
  category       Category        @relation(fields: [categoryId], references: [id])
  stockMovements StockMovement[]
  Inventory      Inventory[]

  @@index([slug])
  @@index([featured])
  @@index([onSale])
  @@index([categoryId])
  @@index([isActive])
  @@index([stock])
  @@map("products")
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String   @db.Text
  image       String
  featured    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parentId String?
  parent   Category?  @relation("CategoryToSubcategories", fields: [parentId], references: [id])
  children Category[] @relation("CategoryToSubcategories")
  products Product[]

  @@map("categories")
}

model Order {
  id          String @id @default(cuid())
  orderNumber String @unique // Human-readable order number

  // Order Status
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  // Pricing Breakdown
  subtotal     Float
  shippingCost Float @default(0)
  tax          Float @default(0)
  discount     Float @default(0)
  total        Float

  // Customer Information
  email  String
  userId String?

  // Shipping Address
  shippingFirstName String
  shippingLastName  String
  shippingAddress   String
  shippingCity      String
  shippingZipCode   String
  shippingCountry   String
  shippingPhone     String?

  // payment information
  paymentMethod     String? // "card", "paypal", "stripe"
  paymentId         String? // Stripe/PayPal transaction ID
  paymentCardEnding String? // Last 4 digits
  paymentExpiryDate String
  paidAt            DateTime?

  // timestamps
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items  OrderItem[]
  user   User?       @relation(fields: [userId], references: [id])
  cart   Cart?       @relation(fields: [cartId], references: [id])
  cartId String?

  @@index([userId])
  @@index([email]) // NEW: For guest order lookup
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  productId   String
  warehouseId String?
  quantity    Int
  price       Float // Price at time of purchase (important!)
  productName String // NEW: Snapshot in case product deleted
  productSku  String? // NEW: For inventory tracking

  product   Product    @relation(fields: [productId], references: [id])
  order     Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  warehouse Warehouse? @relation(fields: [warehouseId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ============================================
// CART & INVENTORY
// ============================================

model CartItem {
  id        String     @id @default(cuid())
  quantity  Int        @default(1)
  cartId    String
  productId String
  status    CartStatus @default(ACTIVE)
  createdAt DateTime   @default(now())

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@index([cartId, status])
  @@map("cart_items")
}

model Cart {
  id        String    @id @default(cuid())
  userId    String?   @unique // Optional - null for guest carts
  sessionId String?   @unique // For guest users
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // for cleanup

  user  User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]
  Order Order[]

  @@index([sessionId])
  @@index([expiresAt])
  @@map("carts")
}

model Warehouse {
  id         String        @id @default(cuid())
  name       String
  code       String        @unique
  address    String
  city       String
  country    String
  postalCode String
  type       WarehouseType @default(MAIN)
  isActive   Boolean       @default(true)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  stockMovements StockMovement[]
  inventory      Inventory[]
  OrderItem      OrderItem[]

  @@map("warehouses")
}

model Inventory {
  id           String   @id @default(cuid())
  productId    String
  warehouseId  String
  quantity     Int      @default(0)
  reserved     Int      @default(0) // NEW: For pending orders
  available    Int      @default(0) // NEW: quantity - reserved
  minStock     Int?     @default(10)
  maxStock     Int?
  reorderPoint Int?     @default(20)
  lastUpdated  DateTime @default(now())

  // Relations
  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
  @@index([productId])
  @@index([available]) // NEW: For stock checks
  @@map("inventory")
}

model StockMovement {
  id           String       @id @default(cuid())
  productId    String
  warehouseId  String
  quantity     Int // Positive for increase, negative for decrease
  stockBefore  Int // NEW: Audit trail
  stockAfter   Int
  movementType MovementType
  referenceId  String? // Order ID, Transfer ID, etc.
  note         String?
  createdAt    DateTime     @default(now())
  createdBy    String?

  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@index([productId])
  @@index([createdAt])
  @@index([movementType])
  @@map("stock_movements")
}

model Subscriber {
  id             String    @id @default(cuid())
  email          String    @unique
  isActive       Boolean   @default(true)
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([isActive])
  @@index([subscribedAt])
  @@map("subscribers")
}

model Campaign {
  id             String   @id @default(cuid())
  title          String
  message        String   @db.Text
  recipientCount Int
  sentAt         DateTime @default(now())
  createdAt      DateTime @default(now())

  @@index([sentAt])
  @@map("campaigns")
}

// ============================================
// ENUMS
// ============================================

enum MovementType {
  SALE // Product sold
  RETURN // Customer return
  RESTOCK // New stock added
  ADJUSTMENT // Manual correction
  RESERVATION // Reserved for order
  RELEASE // Reservation released
  TRANSFER_IN // From another warehouse
  TRANSFER_OUT // To another warehouse
  DAMAGED // Damaged/lost
}

enum WarehouseType {
  MAIN
  REGIONAL
  STORE
  VIRTUAL
}

enum UserRole {
  USER
  ADMIN
}

enum CartStatus {
  ACTIVE
  SAVED_FOR_LATER
  PURCHASED
  ABANDONED
}

enum OrderStatus {
  PENDING // Order created, payment pending
  PROCESSING // Payment confirmed, preparing shipment
  SHIPPED // Order shipped
  DELIVERED // Order delivered
  CANCELLED // Order cancelled
  REFUNDED // Order refunded
}

enum PaymentStatus {
  PENDING // Awaiting payment
  PAID // Payment successful
  FAILED // Payment failed
  REFUNDED // Full refund
  PARTIALLY_REFUNDED
}
